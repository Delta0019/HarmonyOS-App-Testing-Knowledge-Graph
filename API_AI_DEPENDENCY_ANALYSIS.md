# API接口AI模型依赖分析

本文档分析API_SPECIFICATION.md中定义的接口对深度学习模型和大语言模型的依赖情况。

## 一、依赖嵌入模型（Embedding Model）的接口

以下接口需要将文本转换为向量表示，依赖**嵌入模型（Embedding Model）**：

### 1.1 `query_path` - 查询操作路径
- **依赖点**：主要行为第1步 - "通过向量相似度匹配意图，找到目标页面"
- **输入**：`intent`（自然语言描述，如"点外卖"）
- **需要**：将用户意图文本转换为向量，与已注册意图的向量进行相似度匹配
- **模型类型**：文本嵌入模型（如sentence-transformers）

### 1.2 `get_next_action` - 获取下一步操作
- **依赖点**：主要行为第1步 - "根据意图找到目标页面"
- **输入**：`intent`（目标意图）
- **需要**：同样需要意图向量化进行匹配
- **模型类型**：文本嵌入模型

### 1.3 `match_current_page` - 匹配当前页面
- **依赖点**：主要行为第3步 - "使用向量相似度进行语义匹配"
- **输入**：`ui_hierarchy`、`page_title`、`page_screenshot`（可选）
- **需要**：将页面描述、UI结构等信息转换为向量，与图谱中页面的向量进行相似度匹配
- **模型类型**：文本嵌入模型（可能还需要图像嵌入模型，如果使用截图）

### 1.4 `get_rag_context` - 获取RAG上下文
- **依赖点**：主要行为第1步 - "根据查询文本检索相关的页面、操作路径和意图"
- **输入**：`query`（查询文本）
- **需要**：将查询文本转换为向量，进行向量检索
- **模型类型**：文本嵌入模型
- **注意**：此接口**不直接调用LLM**，但生成的`prompt`字段是给外部LLM使用的

### 2.2 `add_page` - 添加页面
- **依赖点**：主要行为第3步 - "生成页面的向量表示并存储"
- **输入**：`page_name`、`description`、`ui_hierarchy`等
- **需要**：将页面描述转换为向量，存储到向量数据库
- **模型类型**：文本嵌入模型

### 2.3 `register_intent` - 注册意图
- **依赖点**：主要行为第2步 - "生成意图的向量表示"
- **输入**：`intent_text`（意图文本）
- **需要**：将意图文本转换为向量，存储到向量数据库
- **模型类型**：文本嵌入模型

### 3.2 `find_similar_intents` - 查找相似意图
- **依赖点**：主要行为第1步 - "使用向量相似度搜索"
- **输入**：`query`（查询文本）
- **需要**：将查询文本转换为向量，在向量数据库中搜索相似意图
- **模型类型**：文本嵌入模型

---

## 二、为LLM生成内容的接口

### 1.4 `get_rag_context` - 获取RAG上下文
- **输出**：`prompt`字段 - "生成的完整提示词（可直接传给LLM）"
- **说明**：此接口**不直接调用LLM**，而是生成结构化的提示词，供外部LLM使用
- **依赖**：需要嵌入模型进行检索，但不需要LLM本身
- **用途**：减少LLM调用次数，提高决策准确性

---

## 三、不依赖AI模型的接口

以下接口只进行图数据库查询、统计计算或数据更新，**不依赖任何AI模型**：

### 2.1 `report_transition` - 上报页面转换
- **操作**：纯数据更新，更新图谱中的统计信息
- **无AI依赖**

### 3.1 `get_available_actions` - 获取页面可用操作
- **操作**：图数据库查询，查找页面的出边
- **无AI依赖**

### 3.3 `get_graph_stats` - 获取图谱统计信息
- **操作**：统计计算，统计节点、边数量等
- **无AI依赖**

### 4.1 `batch_add_transitions` - 批量添加页面转换
- **操作**：批量数据操作
- **无AI依赖**

---

## 四、依赖总结

### 嵌入模型依赖统计
- **依赖嵌入模型的接口**：7个
  - `query_path`
  - `get_next_action`
  - `match_current_page`
  - `get_rag_context`（部分）
  - `add_page`
  - `register_intent`
  - `find_similar_intents`

- **不依赖AI模型的接口**：4个
  - `report_transition`
  - `get_available_actions`
  - `get_graph_stats`
  - `batch_add_transitions`

### LLM依赖统计
- **直接调用LLM的接口**：0个
- **为LLM生成内容的接口**：1个（`get_rag_context`）

---

## 五、技术实现建议

### 嵌入模型选择
1. **文本嵌入模型**：
   - 推荐使用轻量级模型（如sentence-transformers的paraphrase-multilingual-MiniLM）
   - 支持中文语义理解
   - 可本地部署，降低延迟

2. **图像嵌入模型**（如果使用截图匹配）：
   - 可选：CLIP模型
   - 但当前规范中截图匹配是"未来扩展"，暂不必须

### 向量存储
- 使用向量数据库（如Milvus）或内存向量存储
- 支持高效的相似度搜索

### LLM集成
- **不直接集成LLM**，而是通过`get_rag_context`接口生成prompt
- Agent端负责调用LLM，传入生成的prompt
- 这样设计的好处：
  - 知识图谱系统不依赖LLM服务
  - 降低系统复杂度
  - 提高响应速度（大部分查询不需要LLM）

---

## 六、性能优化建议

1. **向量缓存**：对常见意图和页面的向量进行缓存
2. **批量向量化**：对多个文本进行批量向量化，提高效率
3. **模型选择**：在准确性和速度之间平衡，选择适合的模型大小
4. **降级策略**：如果嵌入模型服务不可用，可以降级到关键词匹配

---

## 七、总结

**核心发现**：
1. **大部分接口依赖嵌入模型**（7/11），主要用于语义匹配和相似度搜索
2. **没有接口直接调用LLM**，系统设计为LLM提供上下文，而非直接使用LLM
3. **约1/3的接口不依赖AI模型**，这些接口可以快速响应，适合高频调用

**设计优势**：
- 将AI模型依赖集中在嵌入模型，降低系统复杂度
- LLM调用由Agent端控制，知识图谱系统专注于知识管理和检索
- 大部分查询可以通过向量相似度直接完成，无需LLM参与

